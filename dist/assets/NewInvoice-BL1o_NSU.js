const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/InvoicePreviewModal-C1f75XBU.js","assets/index-DMTdQ3St.js","assets/index-DHljcYHJ.css","assets/Modal-D67shZbf.js","assets/x-CNnEMBry.js","assets/InvoicePreviewContent--PJ4DIc5.js","assets/helpers-kgrKKtTT.js","assets/invoiceDataTransform-CE6YmDep.js","assets/jspdf.es.min-CZuQBE25.js","assets/download-CvjdIAOH.js","assets/send-BrKxFpSO.js","assets/save-Cq4unuqE.js","assets/RecordPaymentModal-Czj0x9qc.js","assets/invoice-BGlX5FmL.js","assets/calendar-CRwE0Pfy.js"])))=>i.map(i=>d[i]);
import{j as e,r,_ as ue,h as He,a as Ue,i as Ge,u as Je,b as Ke,V as f}from"./index-DMTdQ3St.js";import{u as Qe,a as ce}from"./index.esm-DkrFlcfS.js";import{u as We}from"./invoiceStore-ACMv2w23.js";import{u as le}from"./clientStore-Bedc05g4.js";import{c as Xe,e as me,b as Ze,d as et}from"./helpers-kgrKKtTT.js";import{n as tt}from"./invoiceDataTransform-CE6YmDep.js";import{C as de}from"./calendar-CRwE0Pfy.js";import{T as st,I as nt,a as at,M as ot,R as rt,P as it,S as ct}from"./InvoiceNotes-bDBhI5xr.js";import{E as lt,S as mt}from"./send-BrKxFpSO.js";import{C as dt}from"./credit-card-CVK1R5mv.js";import{S as ut}from"./save-Cq4unuqE.js";import{A as pt}from"./arrow-left-DgZupmuo.js";import"./trash-2-B7Y99Ql6.js";const bt=({register:p,errors:c,clients:y,clientEngagementModel:b,watchClientId:n})=>{var v;return e.jsxs("div",{className:"p-4 sm:p-6 border-b border-gray-200",children:[e.jsx("h2",{className:"text-base sm:text-lg font-medium text-gray-900 mb-3 sm:mb-4",children:"Invoice Information"}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 sm:grid-cols-2 sm:gap-6",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"client_id",className:"block text-sm font-medium text-gray-700 mb-1",children:"Client *"}),e.jsxs("select",{id:"client_id",className:`block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm ${c.client_id?"border-red-300":"border-gray-300"}`,...p("client_id",{required:"Client is required"}),children:[e.jsx("option",{value:"",children:"Select a client"}),y.map(o=>e.jsx("option",{value:o.id,children:o.company_name?`${o.name} (${o.company_name})`:o.name},o.id))]}),c.client_id&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:c.client_id.message})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"invoice_number",className:"block text-sm font-medium text-gray-700 mb-1",children:"Invoice Number *"}),e.jsx("input",{type:"text",id:"invoice_number",className:`block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm ${c.invoice_number?"border-red-300":"border-gray-300"}`,...p("invoice_number",{required:"Invoice number is required"})}),c.invoice_number&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:c.invoice_number.message})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"currency",className:"block text-sm font-medium text-gray-700 mb-1",children:"Currency *"}),e.jsx("select",{id:"currency",className:`block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm ${c.currency?"border-red-300":"border-gray-300"}`,...p("currency",{required:"Currency is required"}),children:Xe.map(o=>e.jsx("option",{value:o.value,children:o.label},o.value))})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"engagement_type",className:"block text-sm font-medium text-gray-700 mb-1",children:"Engagement Type *"}),e.jsx("select",{id:"engagement_type",className:"block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm border-gray-300",...p("engagement_type",{required:"Engagement type is required"}),children:me.map(o=>e.jsx("option",{value:o.value,children:o.label},o.value))}),b&&e.jsxs("p",{className:"mt-1 text-xs text-gray-500",children:["Client's default: ",(v=me.find(o=>o.value===b.type))==null?void 0:v.label]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"issue_date",className:"block text-sm font-medium text-gray-700 mb-1",children:"Issue Date *"}),e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx(de,{className:"h-4 w-4 text-gray-400"})}),e.jsx("input",{type:"date",id:"issue_date",className:`block w-full pl-10 px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm ${c.issue_date?"border-red-300":"border-gray-300"}`,...p("issue_date",{required:"Issue date is required"})})]}),c.issue_date&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:c.issue_date.message})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"due_date",className:"block text-sm font-medium text-gray-700 mb-1",children:"Due Date *"}),e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx(de,{className:"h-4 w-4 text-gray-400"})}),e.jsx("input",{type:"date",id:"due_date",className:`block w-full pl-10 px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm ${c.due_date?"border-red-300":"border-gray-300"}`,...p("due_date",{required:"Due date is required"})})]}),c.due_date&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:c.due_date.message})]})]})]})},xt=({loading:p,onCancel:c,onSaveAndSend:y,onSaveAndRecordPayment:b,showPreviewLink:n=!1,onPreviewClick:v})=>e.jsxs("div",{className:"flex flex-col sm:flex-row justify-end space-y-3 sm:space-y-0 sm:space-x-3",children:[e.jsx("button",{type:"button",onClick:c,className:"w-full sm:w-auto btn btn-secondary btn-md",children:"Cancel"}),n&&v&&e.jsxs("button",{type:"button",onClick:v,className:"w-full sm:w-auto btn btn-secondary btn-md",children:[e.jsx(lt,{className:"h-4 w-4 mr-2"}),"Preview"]}),b&&e.jsxs("button",{type:"button",onClick:b,disabled:p,className:"w-full sm:w-auto btn btn-success btn-md group",children:[e.jsx(dt,{className:"h-4 w-4 mr-2 group-hover:scale-110 transition-transform"}),"Save & Record Payment"]}),y&&e.jsxs("button",{type:"button",onClick:y,disabled:p,className:"w-full sm:w-auto btn btn-primary btn-md group",children:[e.jsx(mt,{className:"h-4 w-4 mr-2 group-hover:scale-110 transition-transform"}),p?e.jsxs("span",{className:"flex items-center",children:[e.jsx("span",{className:"h-4 w-4 mr-2 rounded-full border-2 border-white/30 border-t-white animate-spin"}),"Saving..."]}):"Save & Send"]}),e.jsxs("button",{type:"submit",disabled:p,className:"w-full sm:w-auto btn btn-primary btn-md group",children:[e.jsx(ut,{className:"h-4 w-4 mr-2 group-hover:scale-110 transition-transform"}),p?e.jsxs("span",{className:"flex items-center",children:[e.jsx("span",{className:"h-4 w-4 mr-2 rounded-full border-2 border-white/30 border-t-white animate-spin"}),"Saving..."]}):"Save Invoice"]})]}),vt=r.lazy(()=>ue(()=>import("./InvoicePreviewModal-C1f75XBU.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11]))),gt=r.lazy(()=>ue(()=>import("./RecordPaymentModal-Czj0x9qc.js"),__vite__mapDeps([12,1,2,3,4,13,6,14]))),Ft=()=>{var oe,re;const p=He(),c=Ue(),[y]=Ge(),b=((oe=p.state)==null?void 0:oe.isEditing)||y.get("edit")==="true",n=(re=p.state)==null?void 0:re.invoice,v=y.get("client"),{user:o}=Je(),{clients:pe,fetchClients:$,fetchEngagementModel:O,getClient:V}=le(),{createInvoice:be,updateInvoice:xe,generateInvoiceNumber:L,loading:z,recordPayment:ve}=We(),{profile:i,bankingInfo:w,fetchProfile:B,fetchBankingInfo:Y}=Ke(),[q,H]=r.useState(0),[M,U]=r.useState(0),[k,G]=r.useState(0),[C,ge]=r.useState("INR"),[he,fe]=r.useState(null),[m,ye]=r.useState(null),[J,D]=r.useState(!1),[K,_e]=r.useState(null),[je,Q]=r.useState(!1);r.useState(!1);const[W,X]=r.useState(!1),{register:_,control:j,handleSubmit:we,watch:u,setValue:s,reset:ht,formState:{errors:Z}}=Qe({defaultValues:{issue_date:new Date().toISOString().split("T")[0],due_date:Ze(new Date().toISOString(),15),currency:"INR",tax_name:"",tax_percentage:0,items:[{description:"",quantity:1,rate:0,amount:0}],milestones:[{name:"Milestone 1",amount:0}],engagement_type:"service"}}),{fields:A,append:ee,remove:te}=ce({control:j,name:"items"}),{fields:T,append:se,remove:ne}=ce({control:j,name:"milestones"}),E=u("items"),S=u("client_id"),h=u("currency"),g=u("engagement_type"),Ne=u("milestones",[]),R=u("tax_percentage"),ae=u("tax_name"),Se=u("notes"),d=r.useCallback(()=>{try{const t=u(),l=et(t,g);H(l.subtotal),U(l.tax),G(l.total)}catch(t){console.error("Error calculating totals:",t),H(0),U(0),G(0)}},[u,g]),Ie=r.useCallback((t,l,x)=>{const a=l*x;s(`items.${t}.amount`,a),setTimeout(()=>d(),0)},[s,d]),Pe=r.useCallback((t,l)=>{s(`milestones.${t}.amount`,l),setTimeout(()=>d(),0)},[s,d]),ke=r.useCallback(t=>{s("items.0.amount",t),setTimeout(()=>d(),0)},[s,d]),Ce=r.useCallback(t=>{s("items.0.amount",t),s("items.0.quantity",1),setTimeout(()=>d(),0)},[s,d]),Te=r.useCallback((t,l)=>{setTimeout(()=>d(),0)},[d]);r.useEffect(()=>{d(),h!==C&&ge(h)},[h,C,g,R,ae,d]),r.useEffect(()=>{o&&((async()=>{if(!b){const l=await L(o.id);s("invoice_number",l)}})(),$(o.id),B(o.id),Y(o.id),b&&n&&(s("client_id",n.client_id),s("invoice_number",n.invoice_number),s("issue_date",n.issue_date),s("due_date",n.due_date),s("notes",n.notes),s("currency",n.currency),s("engagement_type",n.engagement_type),s("tax_percentage",n.tax_percentage),s("tax_name",n.tax_name||""),n.engagement_type==="milestone"&&n.milestones?s("milestones",n.milestones):n.items&&(s("items",n.items),n.engagement_type==="retainership"&&n.retainer_period&&s("retainer_period",n.retainer_period),n.engagement_type==="project"&&n.project_description&&s("project_description",n.project_description))))},[o,L,s,$,B,Y,b,n]),r.useEffect(()=>{v&&s("client_id",v)},[v,s]),r.useEffect(()=>{S&&(async()=>{try{const l=await V(S);ye(l),await O(S);const x=le.getState().engagementModel;if(fe(x),x){const a=u("engagement_type");(!a||a==="")&&s("engagement_type",x.type)}}catch(l){console.error("Error fetching client details:",l)}})()},[S,O,V,s,u]);const Ee=()=>{const t={issuer:{business_name:(i==null?void 0:i.business_name)||"Your Business",address:(i==null?void 0:i.address)||"",pan_number:i==null?void 0:i.pan_number,phone:i==null?void 0:i.phone,logo_url:(i==null?void 0:i.logo_url)||void 0,primary_color:i==null?void 0:i.primary_color,secondary_color:i==null?void 0:i.secondary_color,footer_text:i==null?void 0:i.footer_text},client:{name:(m==null?void 0:m.name)||"",company_name:m==null?void 0:m.company_name,billing_address:m==null?void 0:m.billing_address,email:m==null?void 0:m.email,phone:m==null?void 0:m.phone,gst_number:m==null?void 0:m.gst_number},banking:w?{account_holder:w.account_holder,account_number:w.account_number,ifsc_code:w.ifsc_code,bank_name:w.bank_name,branch:w.branch}:void 0,invoice:{invoice_number:u("invoice_number"),issue_date:u("issue_date"),due_date:u("due_date"),subtotal:q,tax:M,total:k,notes:Se,currency:h,tax_percentage:R,tax_name:ae,engagement_type:g,items:g!=="milestone"?E:void 0,milestones:g==="milestone"?Ne:void 0,status:"draft"}};return tt(t)},Fe=()=>{_e(Ee()),D(!0)},qe=()=>{D(!1)},Me=async()=>{Q(!0),await I(),Q(!1),D(!1)},I=async t=>{var l,x;if(o)try{d();const a=u(),Ye=t||"draft",ie={user_id:o.id,client_id:a.client_id,invoice_number:a.invoice_number,issue_date:a.issue_date,due_date:a.due_date,status:Ye,subtotal:q,tax:M,total:k,notes:a.notes,currency:a.currency,engagement_type:a.engagement_type,tax_percentage:a.tax_percentage,tax_name:a.tax_name};let P=[];a.engagement_type==="milestone"&&a.milestones?P=a.milestones:a.engagement_type==="project"||a.engagement_type==="retainership"?P=[{description:a.items[0].description||(a.engagement_type==="project"?"Project Fee":"Monthly Retainer Fee"),quantity:1,rate:parseFloat(((l=a.items[0].rate)==null?void 0:l.toString())||"0")||0,amount:parseFloat(((x=a.items[0].amount)==null?void 0:x.toString())||"0")||0}]:P=a.items.map(N=>({description:N.description,quantity:N.quantity,rate:N.rate,amount:N.amount||N.quantity*N.rate}));let F;if(b&&n?(F=await xe(n.id,ie,P),f.success("Invoice updated successfully")):(F=await be(ie,P),f.success("Invoice created successfully")),F)return F.id}catch(a){console.error("Error saving invoice:",a),f.error("Failed to save invoice")}},De=async t=>{await I(),c("/invoices")},Ae=async()=>{const t=await I("sent");t&&(f.success("Invoice saved and marked as sent"),c(`/invoices/${t}`))},Re=async()=>{await I()&&X(!0)},$e=async t=>{const l=await I();if(l)try{await ve(l,t),f.success("Payment recorded successfully"),c(`/invoices/${l}`)}catch(x){console.error("Error recording payment:",x),f.error("Failed to record payment")}},Oe=()=>{ee({description:"",quantity:1,rate:0,amount:0}),setTimeout(()=>d(),0)},Ve=t=>{A.length>1?(te(t),setTimeout(()=>d(),0)):f.error("Invoice must have at least one item")},Le=()=>{se({name:`Milestone ${T.length+1}`,amount:0}),setTimeout(()=>d(),0)},ze=t=>{T.length>1?(ne(t),setTimeout(()=>d(),0)):f.error("You must have at least one milestone")},Be=()=>g==="milestone"?e.jsx(ot,{register:_,control:j,milestoneFields:T,watchCurrency:h,milestonesFieldArray:{fields:T,append:se,remove:ne},addMilestone:Le,removeMilestone:ze,updateMilestoneAmount:Pe}):g==="retainership"?e.jsx(rt,{register:_,control:j,watchCurrency:h,watchItems:E,updateRetainershipAmount:ke}):g==="project"?e.jsx(it,{register:_,control:j,watchCurrency:h,watchItems:E,updateProjectAmount:Ce}):e.jsx(ct,{register:_,control:j,errors:Z,fields:A,watchItems:E,selectedCurrency:C,itemsFieldArray:{fields:A,append:ee,remove:te},addItem:Oe,removeItem:Ve,updateItemAmount:Ie});return e.jsxs("div",{className:"max-w-5xl mx-auto px-4 sm:px-0",children:[e.jsx("div",{className:"flex justify-between items-center mb-4 sm:mb-6",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("button",{type:"button",onClick:()=>c("/invoices"),className:"mr-4 text-gray-500 hover:text-gray-700",children:e.jsx(pt,{className:"h-5 w-5"})}),e.jsx("h1",{className:"text-xl sm:text-2xl font-bold text-gray-900",children:b?"Edit Invoice":"Create New Invoice"})]})}),e.jsxs("form",{onSubmit:we(De),children:[e.jsxs("div",{className:"bg-white rounded-lg shadow overflow-hidden mb-4 sm:mb-6",children:[e.jsx(bt,{register:_,errors:Z,clients:pe,clientEngagementModel:he,watchClientId:S}),Be(),e.jsx(st,{register:_,control:j,updateTaxSettings:Te}),e.jsx(nt,{subtotal:q,tax:M,total:k,selectedCurrency:C,taxPercentage:R}),e.jsx(at,{register:_})]}),e.jsx(xt,{loading:z,onCancel:()=>c("/invoices"),onSaveAndSend:Ae,onSaveAndRecordPayment:Re,showPreviewLink:!0,onPreviewClick:Fe})]}),J&&K&&e.jsx(r.Suspense,{fallback:e.jsx("div",{className:"fixed inset-0 flex items-center justify-center bg-gray-800 bg-opacity-50",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-white"})}),children:e.jsx(vt,{isOpen:J,onClose:qe,data:K,onSave:Me,isSaving:je||z,isUpdate:b})}),W&&e.jsx(r.Suspense,{fallback:e.jsx("div",{className:"fixed inset-0 flex items-center justify-center bg-gray-800 bg-opacity-50",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-white"})}),children:e.jsx(gt,{isOpen:W,onClose:()=>X(!1),onSave:$e,invoice:{id:"",total:k,currency:h,status:"draft"}})})]})};export{Ft as default};
