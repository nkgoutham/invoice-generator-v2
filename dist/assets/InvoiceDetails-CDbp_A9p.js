import{d as Z,u as V,a as ee,b as se,r,j as e,L as I,F as D,D as S,k as te,g as i}from"./index-DMTdQ3St.js";import{u as ae}from"./invoiceStore-ACMv2w23.js";import{u as ne}from"./expenseStore-BpTe1G7s.js";import{f as c,e as re,a as ie}from"./helpers-kgrKKtTT.js";import le from"./RecordPaymentModal-Czj0x9qc.js";import{h as oe,E as ce}from"./jspdf.es.min-CZuQBE25.js";import{n as me}from"./invoiceDataTransform-CE6YmDep.js";import{A as de}from"./arrow-left-DgZupmuo.js";import{C as g}from"./calendar-CRwE0Pfy.js";import{B as xe}from"./briefcase-Cm4uPyTN.js";import{B as pe}from"./building-BwG9NAGn.js";import{M as ue}from"./mail-CvfNZUA1.js";import{P as he}from"./phone-dzjgbDSA.js";import{C as F}from"./credit-card-CVK1R5mv.js";import{E as fe,S as M}from"./send-BrKxFpSO.js";import{D as ge}from"./download-CvjdIAOH.js";import{P as ye}from"./pen-square-DAdg6CDQ.js";import{T as je}from"./trash-2-B7Y99Ql6.js";import"./Modal-D67shZbf.js";import"./x-CNnEMBry.js";import"./invoice-BGlX5FmL.js";const Oe=()=>{const{id:n}=Z(),{user:x}=V(),y=ee(),{selectedInvoice:s,invoiceItems:o,invoiceHistory:be,fetchInvoice:p,fetchInvoiceItems:j,fetchInvoiceHistory:b,updateInvoiceStatus:R,deleteInvoice:T,loading:L,recordPayment:A}=ae(),{profile:l,fetchProfile:N}=se(),{expenses:u,fetchExpenses:v}=ne(),[w,h]=r.useState(!1),[Ne,B]=r.useState(window.innerWidth<640),[_,k]=r.useState(!1),[P,U]=r.useState(null),[ve,$]=r.useState(null),[we,q]=r.useState([]);r.useEffect(()=>{const t=()=>{B(window.innerWidth<640)};return window.addEventListener("resize",t),()=>window.removeEventListener("resize",t)},[]),r.useEffect(()=>{n&&(p(n),j(n),b(n),x&&v(x.id))},[n,x,p,j,b,v]),r.useEffect(()=>{s&&N(s.user_id)},[s,N]),r.useEffect(()=>{if(n&&u.length>0){const t=u.filter(a=>a.invoice_id===n||a.is_billable&&a.client_id===(s==null?void 0:s.client_id));q(t)}},[n,u,s]),r.useEffect(()=>{if(s&&l&&o){const t=s.clients||{},a={issuer:{business_name:l.business_name||"Your Business",address:l.address||"",pan_number:l.pan_number,phone:l.phone,logo_url:l.logo_url,primary_color:l.primary_color,secondary_color:l.secondary_color,footer_text:l.footer_text},client:{name:t.name||"",company_name:t.company_name,billing_address:t.billing_address,email:t.email,phone:t.phone,gst_number:t.gst_number},invoice:{invoice_number:s.invoice_number,issue_date:s.issue_date,due_date:s.due_date,subtotal:s.subtotal,tax:s.tax,total:s.total,notes:s.notes,currency:s.currency||"INR",tax_percentage:s.tax_percentage||0,engagement_type:s.engagement_type,status:s.status,payment_date:s.payment_date,payment_method:s.payment_method,payment_reference:s.payment_reference,is_partially_paid:s.is_partially_paid,partially_paid_amount:s.partially_paid_amount}};s.engagement_type==="milestone"?a.invoice.milestones=o.map(d=>({name:d.description||d.milestone_name||"Milestone",amount:d.amount})):a.invoice.items=o,$(me(a))}},[s,l,o]);const z=async t=>{if(n)try{await R(n,t),i.success(`Invoice marked as ${t}`)}catch(a){console.error("Error updating invoice status:",a),i.error("Failed to update invoice status")}},W=async()=>{if(n&&window.confirm("Are you sure you want to delete this invoice? This action cannot be undone."))try{await T(n),i.success("Invoice deleted successfully"),y("/invoices")}catch(t){console.error("Error deleting invoice:",t),i.error("Failed to delete invoice")}},H=async t=>{if(n)try{const a={...t,status:t.is_partially_paid?"partially_paid":"paid"};await A(n,a),i.success("Payment recorded successfully"),h(!1),p(n)}catch(a){console.error("Error recording payment:",a),i.error("Failed to record payment")}},O=async()=>{if(!P){i.error("Cannot generate PDF at this time");return}k(!0);try{const t=P.cloneNode(!0);t.classList.add("pdf-mode"),t.style.position="absolute",t.style.left="-9999px",t.style.width="1024px",document.body.appendChild(t);const a=await oe(t,{scale:1.5,logging:!1,useCORS:!0,allowTaint:!0,backgroundColor:"#FFFFFF",windowWidth:1200,width:1024});document.body.removeChild(t);const d=a.toDataURL("image/jpeg",.8),C=new ce({orientation:"portrait",unit:"mm",format:"a4",compress:!0}),E=210,X=a.height*E/a.width;C.addImage(d,"JPEG",0,0,E,X),C.save(`Invoice-${s==null?void 0:s.invoice_number}.pdf`),i.success("PDF downloaded successfully")}catch(t){console.error("Error generating PDF:",t),i.error("Failed to generate PDF")}finally{k(!1)}},G=()=>{var a;const t=(a=s==null?void 0:s.clients)==null?void 0:a.email;if(!t){i.error("Client email address is missing");return}i.success(`Invoice would be sent to ${t}`)},J=()=>{y("/invoices/new",{state:{isEditing:!0,invoice:{...s,items:o,milestones:s.engagement_type==="milestone"?o.map(t=>({name:t.description||t.milestone_name||"",amount:t.amount})):void 0}}})},Q=t=>{switch(t){case"draft":return"bg-gray-100 text-gray-800";case"sent":return"bg-blue-100 text-blue-800";case"paid":return"bg-green-100 text-green-800";case"overdue":return"bg-red-100 text-red-800";case"partially_paid":return"bg-yellow-100 text-yellow-800";default:return"bg-gray-100 text-gray-800"}},Y=t=>{if(!t)return"";const a=re.find(d=>d.value===t);return a?a.label:""};if(L||!s)return e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"})});const m=s.clients||{},K=t=>t?{bank_transfer:"Bank Transfer",cash:"Cash",cheque:"Cheque",upi:"UPI",other:"Other"}[t]||t:"",f=t=>{if(!t)return"";try{return ie(t)}catch(a){return console.error("Invalid date value:",t,a),""}};return e.jsxs("div",{className:"max-w-5xl mx-auto px-4 sm:px-0",ref:t=>U(t),children:[e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-y-3 mb-4 sm:mb-6",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(I,{to:"/invoices",className:"mr-3 text-gray-500 hover:text-gray-700",children:e.jsx(de,{className:"h-5 w-5"})}),e.jsxs("h1",{className:"text-xl sm:text-2xl font-bold text-gray-900 truncate",children:["Invoice ",s.invoice_number]})]}),e.jsx("div",{className:"flex space-x-2 self-end sm:self-auto",children:e.jsx("span",{className:`px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${Q(s.status)}`,children:s.status==="partially_paid"?"Partially Paid":s.status.charAt(0).toUpperCase()+s.status.slice(1)})})]}),e.jsxs("div",{className:"bg-white shadow rounded-lg overflow-hidden mb-4 sm:mb-6",children:[e.jsx("div",{className:"p-4 sm:p-6 border-b border-gray-200",children:e.jsxs("div",{className:"flex flex-col lg:flex-row lg:justify-between gap-6",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Invoice Information"}),e.jsxs("div",{className:"mt-3 grid grid-cols-1 sm:grid-cols-2 gap-y-2 gap-x-4",children:[e.jsxs("div",{className:"flex items-center text-sm",children:[e.jsx(D,{className:"mr-2 h-4 w-4 text-gray-500 flex-shrink-0"}),e.jsx("span",{className:"text-gray-500",children:"Invoice Number:"}),e.jsx("span",{className:"ml-2 font-medium",children:s.invoice_number})]}),e.jsxs("div",{className:"flex items-center text-sm",children:[e.jsx(g,{className:"mr-2 h-4 w-4 text-gray-500 flex-shrink-0"}),e.jsx("span",{className:"text-gray-500",children:"Issue Date:"}),e.jsx("span",{className:"ml-2 font-medium",children:f(s.issue_date)})]}),e.jsxs("div",{className:"flex items-center text-sm",children:[e.jsx(g,{className:"mr-2 h-4 w-4 text-gray-500 flex-shrink-0"}),e.jsx("span",{className:"text-gray-500",children:"Due Date:"}),e.jsx("span",{className:"ml-2 font-medium",children:f(s.due_date)})]}),e.jsxs("div",{className:"flex items-center text-sm",children:[e.jsx(S,{className:"mr-2 h-4 w-4 text-gray-500 flex-shrink-0"}),e.jsx("span",{className:"text-gray-500",children:"Currency:"}),e.jsx("span",{className:"ml-2 font-medium",children:s.currency||"INR"})]}),s.engagement_type&&e.jsxs("div",{className:"flex items-center text-sm",children:[e.jsx(xe,{className:"mr-2 h-4 w-4 text-gray-500 flex-shrink-0"}),e.jsx("span",{className:"text-gray-500",children:"Engagement Type:"}),e.jsx("span",{className:"ml-2 font-medium",children:Y(s.engagement_type)})]})]})]}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Client Information"}),e.jsxs("div",{className:"mt-3 grid grid-cols-1 gap-y-2",children:[e.jsxs("div",{className:"flex items-start text-sm",children:[e.jsx(te,{className:"mr-2 h-4 w-4 text-gray-500 mt-0.5 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Client:"}),e.jsx("span",{className:"ml-2 font-medium",children:m.name})]})]}),m.company_name&&e.jsxs("div",{className:"flex items-start text-sm",children:[e.jsx(pe,{className:"mr-2 h-4 w-4 text-gray-500 mt-0.5 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Company:"}),e.jsx("span",{className:"ml-2 font-medium",children:m.company_name})]})]}),m.email&&e.jsxs("div",{className:"flex items-start text-sm",children:[e.jsx(ue,{className:"mr-2 h-4 w-4 text-gray-500 mt-0.5 flex-shrink-0"}),e.jsxs("div",{className:"overflow-hidden",children:[e.jsx("span",{className:"text-gray-500",children:"Email:"}),e.jsx("span",{className:"ml-2 font-medium truncate block",children:m.email})]})]}),m.phone&&e.jsxs("div",{className:"flex items-start text-sm",children:[e.jsx(he,{className:"mr-2 h-4 w-4 text-gray-500 mt-0.5 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Phone:"}),e.jsx("span",{className:"ml-2 font-medium",children:m.phone})]})]})]})]})]})}),(s.status==="paid"||s.status==="partially_paid")&&e.jsxs("div",{className:"p-4 sm:p-6 border-b border-gray-200 bg-green-50",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Payment Information"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[s.payment_date&&e.jsxs("div",{className:"flex items-center text-sm",children:[e.jsx(g,{className:"mr-2 h-4 w-4 text-green-600 flex-shrink-0"}),e.jsx("span",{className:"text-gray-600",children:"Payment Date:"}),e.jsx("span",{className:"ml-2 font-medium",children:f(s.payment_date)})]}),s.payment_method&&e.jsxs("div",{className:"flex items-center text-sm",children:[e.jsx(F,{className:"mr-2 h-4 w-4 text-green-600 flex-shrink-0"}),e.jsx("span",{className:"text-gray-600",children:"Payment Method:"}),e.jsx("span",{className:"ml-2 font-medium",children:K(s.payment_method)})]}),s.payment_reference&&e.jsxs("div",{className:"flex items-center text-sm",children:[e.jsx(D,{className:"mr-2 h-4 w-4 text-green-600 flex-shrink-0"}),e.jsx("span",{className:"text-gray-600",children:"Reference:"}),e.jsx("span",{className:"ml-2 font-medium",children:s.payment_reference})]}),s.status==="partially_paid"&&s.partially_paid_amount!==void 0&&e.jsxs("div",{className:"flex items-start text-sm",children:[e.jsx(S,{className:"mr-2 h-4 w-4 text-green-600 mt-0.5 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Amount Paid:"}),e.jsx("span",{className:"ml-2 font-medium",children:c(s.partially_paid_amount,s.currency)}),e.jsxs("span",{className:"block text-gray-500 mt-0.5",children:["Balance: ",c(s.total-s.partially_paid_amount,s.currency)]})]})]})]})]}),e.jsxs("div",{className:"p-4 sm:p-6 border-b border-gray-200",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Invoice Items"}),e.jsx("div",{className:"overflow-x-auto -mx-4 sm:-mx-6",children:e.jsx("div",{className:"inline-block min-w-full align-middle px-4 sm:px-6",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsx("tr",{children:s.engagement_type==="milestone"?e.jsxs(e.Fragment,{children:[e.jsx("th",{scope:"col",className:"px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Milestone"}),e.jsx("th",{scope:"col",className:"px-3 sm:px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Amount"})]}):e.jsxs(e.Fragment,{children:[e.jsx("th",{scope:"col",className:"px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Description"}),e.jsx("th",{scope:"col",className:"px-3 sm:px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Qty"}),e.jsx("th",{scope:"col",className:"px-3 sm:px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Rate"}),e.jsx("th",{scope:"col",className:"px-3 sm:px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Amount"})]})})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:o.length>0?s.engagement_type==="milestone"?o.map(t=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-3 sm:px-6 py-4 text-sm text-gray-900",children:t.description||t.milestone_name||"Milestone"}),e.jsx("td",{className:"px-3 sm:px-6 py-4 text-right text-sm text-gray-900 font-medium whitespace-nowrap",children:c(t.amount,s.currency)})]},t.id)):o.map(t=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-3 sm:px-6 py-4 text-sm text-gray-900",children:t.description}),e.jsx("td",{className:"px-3 sm:px-6 py-4 text-right text-sm text-gray-700 whitespace-nowrap",children:t.quantity}),e.jsx("td",{className:"px-3 sm:px-6 py-4 text-right text-sm text-gray-700 whitespace-nowrap",children:c(t.rate,s.currency)}),e.jsx("td",{className:"px-3 sm:px-6 py-4 text-right text-sm text-gray-900 font-medium whitespace-nowrap",children:c(t.amount,s.currency)})]},t.id)):e.jsx("tr",{children:e.jsx("td",{colSpan:s.engagement_type==="milestone"?2:4,className:"px-3 sm:px-6 py-4 text-center text-sm text-gray-500",children:"No items found for this invoice"})})})]})})}),e.jsx("div",{className:"mt-6 border-t border-gray-200 pt-4",children:e.jsx("div",{className:"flex flex-col items-end",children:e.jsxs("div",{className:"w-full sm:w-64 space-y-2",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-sm font-medium text-gray-500",children:"Subtotal:"}),e.jsx("span",{className:"text-sm font-medium text-gray-900",children:c(s.subtotal,s.currency)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-sm font-medium text-gray-500",children:"Tax:"}),e.jsx("span",{className:"text-sm font-medium text-gray-900",children:c(s.tax,s.currency)})]}),e.jsxs("div",{className:"pt-2 border-t border-gray-200 flex justify-between",children:[e.jsx("span",{className:"text-base font-medium text-gray-900",children:"Total:"}),e.jsx("span",{className:"text-base font-medium text-blue-600",children:c(s.total,s.currency)})]})]})})})]}),s.notes&&e.jsxs("div",{className:"p-4 sm:p-6 border-b border-gray-200",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900 mb-2",children:"Notes"}),e.jsx("p",{className:"text-sm text-gray-600",children:s.notes})]}),e.jsxs("div",{className:"p-4 sm:p-6 flex flex-wrap gap-2",children:[e.jsxs(I,{to:`/invoices/${n}/preview`,className:"inline-flex items-center px-3 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500",children:[e.jsx(fe,{className:"mr-1.5 h-4 w-4"}),e.jsx("span",{className:"hidden xs:inline",children:"View Invoice"})]}),e.jsxs("button",{type:"button",className:"inline-flex items-center px-3 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500",onClick:O,disabled:_,children:[e.jsx(ge,{className:"mr-1.5 h-4 w-4"}),e.jsx("span",{className:"hidden xs:inline",children:_?"Generating...":"Download PDF"})]}),e.jsxs("button",{type:"button",className:"inline-flex items-center px-3 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500",onClick:G,children:[e.jsx(M,{className:"mr-1.5 h-4 w-4"}),e.jsx("span",{className:"hidden xs:inline",children:"Send"})]}),(s.status==="sent"||s.status==="overdue"||s.status==="partially_paid"||s.status==="draft")&&e.jsxs("button",{type:"button",className:"inline-flex items-center px-3 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500",onClick:()=>h(!0),children:[e.jsx(F,{className:"mr-1.5 h-4 w-4"}),e.jsx("span",{className:"hidden xs:inline",children:s.status==="partially_paid"?"Update Payment":"Record Payment"})]}),s.status==="draft"&&e.jsxs("button",{type:"button",className:"inline-flex items-center px-3 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500",onClick:()=>z("sent"),children:[e.jsx(M,{className:"mr-1.5 h-4 w-4"}),e.jsx("span",{className:"hidden xs:inline",children:"Mark as Sent"})]}),e.jsxs("button",{type:"button",className:"inline-flex items-center px-3 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-yellow-600 hover:bg-yellow-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500",onClick:J,children:[e.jsx(ye,{className:"mr-1.5 h-4 w-4"}),e.jsx("span",{className:"hidden xs:inline",children:"Edit"})]}),e.jsxs("button",{type:"button",className:"inline-flex items-center px-3 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500",onClick:W,children:[e.jsx(je,{className:"mr-1.5 h-4 w-4"}),e.jsx("span",{className:"hidden xs:inline",children:"Delete"})]})]})]}),w&&e.jsx(le,{isOpen:w,onClose:()=>h(!1),onSave:H,invoice:s})]})};export{Oe as default};
