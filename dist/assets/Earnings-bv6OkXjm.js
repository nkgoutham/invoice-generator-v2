import{c as q,u as G,r as i,s as Q,V as M,j as e,R as W}from"./index-DMTdQ3St.js";import{u as X}from"./currencyStore-CTj-PELi.js";import{e as L}from"./react-datepicker-WcPCAPPC.js";import{f as b,a as V}from"./helpers-kgrKKtTT.js";import{D as Z}from"./download-CvjdIAOH.js";import{C as H}from"./calendar-CRwE0Pfy.js";import{F as ee}from"./filter-CpVmvab7.js";import"./defineProperty-DroM-Dno.js";/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const S=q("ArrowDown",[["path",{d:"M12 5v14",key:"s699le"}],["path",{d:"m19 12-7 7-7-7",key:"1idqje"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const R=q("ArrowUp",[["path",{d:"m5 12 7-7 7 7",key:"hav0vg"}],["path",{d:"M12 19V5",key:"x0mq9r"}]]),me=()=>{const{user:w}=G(),{currencySettings:o,fetchCurrencySettings:k}=X(),[v,C]=i.useState(!1),[d,J]=i.useState(()=>{const t=new Date;return t.setDate(1),t.setHours(0,0,0,0),t}),[m,O]=i.useState(()=>{const t=new Date;return t.setMonth(t.getMonth()+1,0),t.setHours(23,59,59,999),t}),[p,E]=i.useState([]),[P,te]=i.useState("monthly"),[h,B]=i.useState("period"),[y,$]=i.useState("desc"),[F,A]=i.useState(!1);i.useEffect(()=>{w&&k(w.id)},[w,k]),i.useEffect(()=>{U()},[d,m,P,o]);const U=async()=>{if(w){C(!0);try{const t=d.toISOString(),s=m.toISOString(),r=(o==null?void 0:o.preferred_currency)||"INR",a=(o==null?void 0:o.usd_to_inr_rate)||85,{data:n,error:l}=await Q.from("invoices").select(`
          id,
          client_id,
          currency,
          total,
          subtotal,
          status,
          payment_date,
          partially_paid_amount,
          clients(name, company_name)
        `).eq("user_id",w.id).in("status",["paid","partially_paid"]).gte("payment_date",t.split("T")[0]).lte("payment_date",s.split("T")[0]).order("payment_date",{ascending:!1});if(l)throw new Error(`Error fetching invoices: ${l.message}`);const g=K(n||[],r,a);E(T(g.history,h,y))}catch(t){console.error("Error fetching revenue data:",t);let s="Failed to fetch revenue data";t instanceof Error&&(s=`${s}: ${t.message}`),M.error(s),E([])}finally{C(!1)}}},K=(t,s,r)=>{const a=new Map;let n=0,l=0;t.forEach(u=>{const f=new Date(u.payment_date),N=f.getFullYear(),j=f.getMonth(),D=`${N}-${String(j+1).padStart(2,"0")}`,c=u.status==="partially_paid"&&u.partially_paid_amount!==null?u.partially_paid_amount:u.total;a.has(D)||a.set(D,{inr:0,usd:0,total:0});const x=a.get(D);u.currency==="USD"?(x.usd+=c,l+=c,s==="USD"?x.total+=c:x.total+=c*r):(x.inr+=c,n+=c,s==="INR"?x.total+=c:x.total+=c/r)});const g=s==="INR"?n+l*r:n/r+l;return{history:Array.from(a.entries()).map(([u,f])=>{const[N,j]=u.split("-"),c=["January","February","March","April","May","June","July","August","September","October","November","December"][parseInt(j)-1],x=new Date(parseInt(N),parseInt(j)-1,1);return{period:`${c} ${N}`,monthNumber:parseInt(j),year:parseInt(N),sortableDate:x,amount_inr:f.inr,amount_usd:f.usd,total:f.total}}),total:g,inr:n,usd:l}},T=(t,s,r)=>[...t].sort((a,n)=>{if(s==="period"){const l=a.sortableDate.getTime(),g=n.sortableDate.getTime();return r==="asc"?l-g:g-l}else if(s==="amount_inr"||s==="amount_usd"||s==="total")return r==="asc"?a[s]-n[s]:n[s]-a[s];return 0}),_=t=>{h===t?$(y==="asc"?"desc":"asc"):(B(t),$("desc")),E(s=>T(s,t,h===t&&y==="asc"?"desc":"asc"))},Y=()=>{A(!0);try{let t="data:text/csv;charset=utf-8,";t+=`Period,Revenue (INR),Revenue (USD),Total Revenue
`,p.forEach(a=>{t+=`${a.period},${a.amount_inr||0},${a.amount_usd||0},${a.total||0}
`});const s=encodeURI(t),r=document.createElement("a");r.setAttribute("href",s),r.setAttribute("download",`revenue_report_${V(d)}_to_${V(m)}.csv`),document.body.appendChild(r),r.click(),document.body.removeChild(r),M.success("Report exported successfully")}catch(t){console.error("Error exporting data:",t),M.error("Failed to export report")}finally{A(!1)}},z=()=>`${d.toLocaleString("default",{month:"long",year:"numeric"})} to ${m.toLocaleString("default",{month:"long",year:"numeric"})}`,I=()=>(o==null?void 0:o.preferred_currency)||"INR";return e.jsxs("div",{className:"max-w-7xl mx-auto px-4 sm:px-0",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6",children:[e.jsx("h1",{className:"text-xl sm:text-2xl font-bold text-gray-900",children:"Revenue Report"}),e.jsxs("button",{onClick:Y,disabled:F||v||p.length===0,className:"w-full sm:w-auto inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50",children:[e.jsx(Z,{className:"mr-2 h-4 w-4"}),F?"Exporting...":"Export CSV"]})]}),e.jsx("div",{className:"bg-white shadow rounded-lg mb-6",children:e.jsx("div",{className:"p-4 sm:p-6 border-b border-gray-200",children:e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"start-date",className:"block text-sm font-medium text-gray-700 mb-1",children:"Start Date"}),e.jsxs("div",{className:"relative",children:[e.jsx(L,{id:"start-date",selected:d,onChange:t=>J(t),selectsStart:!0,startDate:d,endDate:m,maxDate:m,className:"block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm",dateFormat:"MMMM d, yyyy"}),e.jsx("div",{className:"absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none",children:e.jsx(H,{className:"h-5 w-5 text-gray-400"})})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"end-date",className:"block text-sm font-medium text-gray-700 mb-1",children:"End Date"}),e.jsxs("div",{className:"relative",children:[e.jsx(L,{id:"end-date",selected:m,onChange:t=>O(t),selectsEnd:!0,startDate:d,endDate:m,minDate:d,className:"block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm",dateFormat:"MMMM d, yyyy"}),e.jsx("div",{className:"absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none",children:e.jsx(H,{className:"h-5 w-5 text-gray-400"})})]})]}),e.jsx("div",{className:"flex items-end",children:e.jsx("button",{type:"button",onClick:U,disabled:v,className:"w-full inline-flex justify-center items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50",children:v?e.jsxs("span",{className:"flex items-center",children:[e.jsx("span",{className:"h-4 w-4 mr-2 rounded-full border-2 border-white/30 border-t-white animate-spin"}),"Loading..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ee,{className:"mr-2 h-4 w-4"}),"Apply Filters"]})})})]})})}),e.jsxs("div",{className:"bg-white shadow rounded-lg overflow-hidden",children:[e.jsxs("div",{className:"px-4 py-5 sm:px-6 border-b border-gray-200",children:[e.jsxs("h2",{className:"text-lg leading-6 font-medium text-gray-900",children:["Revenue Report: ",z()]}),e.jsxs("p",{className:"mt-1 text-sm text-gray-500",children:["Monthly revenue breakdown in ",I()]})]}),v?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx(W,{className:"h-8 w-8 animate-spin text-blue-500"})}):p.length===0?e.jsx("div",{className:"text-center py-12",children:e.jsx("p",{className:"text-gray-500",children:"No revenue data available for the selected period"})}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100",onClick:()=>_("period"),children:e.jsxs("div",{className:"flex items-center",children:["Period",h==="period"&&(y==="asc"?e.jsx(R,{className:"ml-1 h-3 w-3"}):e.jsx(S,{className:"ml-1 h-3 w-3"}))]})}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100",onClick:()=>_("amount_inr"),children:e.jsxs("div",{className:"flex items-center justify-end",children:["INR Revenue",h==="amount_inr"&&(y==="asc"?e.jsx(R,{className:"ml-1 h-3 w-3"}):e.jsx(S,{className:"ml-1 h-3 w-3"}))]})}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100",onClick:()=>_("amount_usd"),children:e.jsxs("div",{className:"flex items-center justify-end",children:["USD Revenue",h==="amount_usd"&&(y==="asc"?e.jsx(R,{className:"ml-1 h-3 w-3"}):e.jsx(S,{className:"ml-1 h-3 w-3"}))]})}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100",onClick:()=>_("total"),children:e.jsxs("div",{className:"flex items-center justify-end",children:["Total Revenue",h==="total"&&(y==="asc"?e.jsx(R,{className:"ml-1 h-3 w-3"}):e.jsx(S,{className:"ml-1 h-3 w-3"}))]})})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:p.map((t,s)=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900",children:t.period}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-right text-gray-500",children:b(t.amount_inr||0,"INR")}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-right text-gray-500",children:b(t.amount_usd||0,"USD")}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-right font-medium text-gray-900",children:b(t.total||0,I())})]},s))}),e.jsx("tfoot",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900",children:"Total"}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-right font-bold text-gray-900",children:b(p.reduce((t,s)=>t+(s.amount_inr||0),0),"INR")}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-right font-bold text-gray-900",children:b(p.reduce((t,s)=>t+(s.amount_usd||0),0),"USD")}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-right font-bold text-gray-900",children:b(p.reduce((t,s)=>t+(s.total||0),0),I())})]})})]})})]})]})};export{me as default};
