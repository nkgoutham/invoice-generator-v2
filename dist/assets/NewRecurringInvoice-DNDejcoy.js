import{a as ue,u as xe,r as i,j as e,V as j}from"./index-DMTdQ3St.js";import{u as pe,a as V}from"./index.esm-DkrFlcfS.js";import{u as U}from"./clientStore-Bedc05g4.js";import{u as he}from"./recurringInvoiceStore-Bk_4mFo2.js";import{T as fe,I as be,a as ge,S as ye,P as je,R as ve,M as Ne}from"./InvoiceNotes-bDBhI5xr.js";import{F as _e}from"./invoice-BGlX5FmL.js";import{A as Se}from"./arrow-left-DgZupmuo.js";import{C as B}from"./calendar-CRwE0Pfy.js";import{S as we}from"./save-Cq4unuqE.js";import"./trash-2-B7Y99Ql6.js";import"./helpers-kgrKKtTT.js";const $e=()=>{const I=ue(),{user:v}=xe(),{clients:L,fetchClients:q,fetchEngagementModel:R,getClient:M}=U(),{createRecurringInvoice:Y,loading:A}=he(),[Q,W]=i.useState(0),[z,G]=i.useState(0),[H,J]=i.useState(0),[_,K]=i.useState("INR"),[l,X]=i.useState(null),[Ce,Z]=i.useState(null),{register:o,control:h,handleSubmit:ee,setValue:r,watch:p,formState:{errors:u}}=pe({defaultValues:{title:"",frequency:"monthly",start_date:new Date().toISOString().split("T")[0],end_date:"",auto_send:!1,issue_date:new Date().toISOString().split("T")[0],due_date:"",currency:"INR",tax_percentage:0,items:[{description:"",quantity:1,rate:0,amount:0}],milestones:[{name:"Milestone 1",amount:0}]}}),{fields:F,append:D,remove:P}=V({control:h,name:"items"}),{fields:S,append:E,remove:$}=V({control:h,name:"milestones"}),c=p("items"),w=p("client_id"),b=p("currency"),m=p("engagement_type"),g=p("milestones",[]),y=p("tax_percentage"),n=i.useCallback(()=>{var f,O;const t=c||[];let s=0;m==="milestone"&&g.length>0?s=g.reduce((C,T)=>{var N;const k=parseFloat(((N=T.amount)==null?void 0:N.toString())||"0")||0;return C+k},0):(m==="retainership"||m==="project")&&t.length>0?s=parseFloat(((O=(f=t[0])==null?void 0:f.amount)==null?void 0:O.toString())||"0")||0:s=t.reduce((C,T)=>{var N;const k=parseFloat(((N=T.amount)==null?void 0:N.toString())||"0")||0;return C+k},0);const a=parseFloat((y==null?void 0:y.toString())||"0")||0,x=s*(a/100),d=s+x;W(Math.round(s*100)/100),G(Math.round(x*100)/100),J(Math.round(d*100)/100)},[c,m,g,y]),te=i.useCallback((t,s,a)=>{const x=s*a;r(`items.${t}.amount`,x),setTimeout(()=>n(),0)},[r,n]),se=i.useCallback((t,s)=>{r(`milestones.${t}.amount`,s),setTimeout(()=>n(),0)},[r,n]),re=i.useCallback(t=>{r("items.0.amount",t),setTimeout(()=>n(),0)},[r,n]),ae=i.useCallback(t=>{r("items.0.amount",t),setTimeout(()=>n(),0)},[r,n]),ne=i.useCallback(t=>{setTimeout(()=>n(),0)},[n]);i.useEffect(()=>{n(),b!==_&&K(b)},[b,_,m,y,n]),i.useEffect(()=>{v&&q(v.id)},[v,q]),i.useEffect(()=>{w&&(async()=>{try{const s=await M(w);Z(s),await R(w);const a=U.getState().engagementModel;if(X(a),a){if(r("engagement_type",a.type),a.type==="retainership"&&a.retainer_amount)r("items",[{description:"Monthly Retainer Fee",quantity:1,rate:a.retainer_amount,amount:a.retainer_amount}]);else if(a.type==="project"&&a.project_value)r("items",[{description:"Project Fee",quantity:1,rate:a.project_value,amount:a.project_value}]);else if(a.type==="service"&&a.service_rates&&a.service_rates.length>0){const x=a.service_rates[0].rate,d=c.map(f=>({...f,rate:f.rate||x,amount:f.quantity*(f.rate||x)}));r("items",d)}setTimeout(()=>n(),0)}else r("engagement_type","service")}catch(s){console.error("Error fetching client details:",s),r("engagement_type","service")}})()},[w,R,M,r,c,n]),i.useEffect(()=>{var t,s,a,x;if(m){if(m==="retainership"){if(c.length===0||((t=c[0])==null?void 0:t.description)!=="Monthly Retainer Fee"){const d=(l==null?void 0:l.retainer_amount)||0;r("items",[{description:"Monthly Retainer Fee",quantity:1,rate:d,amount:d}])}}else if(m==="project"){if(c.length===0||((s=c[0])==null?void 0:s.description)!=="Project Fee"){const d=(l==null?void 0:l.project_value)||0;r("items",[{description:"Project Fee",quantity:1,rate:d,amount:d}])}}else if(m==="milestone")(!g||g.length===0)&&r("milestones",[{name:"Milestone 1",amount:0}]);else if(m==="service"&&c.length===0){const d=((x=(a=l==null?void 0:l.service_rates)==null?void 0:a[0])==null?void 0:x.rate)||0;r("items",[{description:"Professional Services",quantity:1,rate:d,amount:d}])}setTimeout(()=>n(),0)}},[m,r,l,c,g,n]),i.useEffect(()=>{const t=p("issue_date");if(t){const s=new Date(t);s.setDate(s.getDate()+15),r("due_date",s.toISOString().split("T")[0])}},[p,r]);const ie=async t=>{if(v){if(!t.client_id){j.error("Please select a client");return}if(!t.title.trim()){j.error("Please provide a title for the recurring invoice");return}try{n();const s=await Y(t,v.id,t.client_id);s&&(j.success("Recurring invoice created successfully"),I(`/recurring/${s.id}`))}catch(s){console.error("Error creating recurring invoice:",s),j.error("Failed to create recurring invoice")}}},oe=()=>{D({description:"",quantity:1,rate:0,amount:0}),setTimeout(()=>n(),0)},le=t=>{F.length>1?(P(t),setTimeout(()=>n(),0)):j.error("Invoice must have at least one item")},ce=()=>{E({name:`Milestone ${S.length+1}`,amount:0}),setTimeout(()=>n(),0)},me=t=>{S.length>1?($(t),setTimeout(()=>n(),0)):j.error("You must have at least one milestone")},de=()=>{switch(m){case"milestone":return e.jsx(Ne,{register:o,control:h,milestoneFields:S,watchCurrency:b,milestonesFieldArray:{fields:S,append:E,remove:$},addMilestone:ce,removeMilestone:me,updateMilestoneAmount:se});case"retainership":return e.jsx(ve,{register:o,control:h,watchCurrency:b,watchItems:c,updateRetainershipAmount:re});case"project":return e.jsx(je,{register:o,control:h,watchCurrency:b,watchItems:c,updateProjectAmount:ae});case"service":default:return e.jsx(ye,{register:o,control:h,errors:u,fields:F,watchItems:c,selectedCurrency:_,itemsFieldArray:{fields:F,append:D,remove:P},addItem:oe,removeItem:le,updateItemAmount:te})}};return e.jsxs("div",{className:"max-w-5xl mx-auto",children:[e.jsx("div",{className:"flex justify-between items-center mb-6",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("button",{type:"button",onClick:()=>I("/recurring"),className:"mr-4 text-gray-500 hover:text-gray-700",children:e.jsx(Se,{className:"h-5 w-5"})}),e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Create Recurring Invoice"})]})}),e.jsxs("form",{onSubmit:ee(ie),children:[e.jsxs("div",{className:"bg-white rounded-lg shadow overflow-hidden mb-6",children:[e.jsxs("div",{className:"p-4 sm:p-6 border-b border-gray-200",children:[e.jsx("h2",{className:"text-lg font-medium text-gray-900 mb-4",children:"Recurring Invoice Details"}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 sm:grid-cols-2 sm:gap-6",children:[e.jsxs("div",{className:"sm:col-span-2",children:[e.jsx("label",{htmlFor:"title",className:"block text-sm font-medium text-gray-700 mb-1",children:"Title *"}),e.jsx("input",{type:"text",id:"title",className:`block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm ${u.title?"border-red-300":"border-gray-300"}`,placeholder:"e.g., Monthly Website Maintenance",...o("title",{required:"Title is required"})}),u.title&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:u.title.message})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"client_id",className:"block text-sm font-medium text-gray-700 mb-1",children:"Client *"}),e.jsxs("select",{id:"client_id",className:`block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm ${u.client_id?"border-red-300":"border-gray-300"}`,...o("client_id",{required:"Client is required"}),children:[e.jsx("option",{value:"",children:"Select a client"}),L.map(t=>e.jsx("option",{value:t.id,children:t.company_name?`${t.name} (${t.company_name})`:t.name},t.id))]}),u.client_id&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:u.client_id.message})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"frequency",className:"block text-sm font-medium text-gray-700 mb-1",children:"Frequency *"}),e.jsx("select",{id:"frequency",className:"block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm",...o("frequency",{required:"Frequency is required"}),children:_e.map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"start_date",className:"block text-sm font-medium text-gray-700 mb-1",children:"Start Date *"}),e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx(B,{className:"h-4 w-4 text-gray-400"})}),e.jsx("input",{type:"date",id:"start_date",className:`block w-full pl-10 px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm ${u.start_date?"border-red-300":"border-gray-300"}`,...o("start_date",{required:"Start date is required"})})]}),u.start_date&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:u.start_date.message})]}),e.jsxs("div",{children:[e.jsxs("label",{htmlFor:"end_date",className:"block text-sm font-medium text-gray-700 mb-1",children:["End Date ",e.jsx("span",{className:"text-gray-500 font-normal",children:"(Optional)"})]}),e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx(B,{className:"h-4 w-4 text-gray-400"})}),e.jsx("input",{type:"date",id:"end_date",className:"block w-full pl-10 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm",...o("end_date")})]}),e.jsx("p",{className:"mt-1 text-xs text-gray-500",children:"Leave blank for no end date (continuous billing)"})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{id:"auto_send",type:"checkbox",className:"h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded",...o("auto_send")}),e.jsx("label",{htmlFor:"auto_send",className:"ml-2 block text-sm text-gray-700",children:"Automatically send invoices to client"})]})]})]}),e.jsxs("div",{className:"p-4 sm:p-6 border-b border-gray-200",children:[e.jsx("h2",{className:"text-lg font-medium text-gray-900 mb-4",children:"Invoice Template"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"currency",className:"block text-sm font-medium text-gray-700 mb-1",children:"Currency *"}),e.jsxs("select",{id:"currency",className:`block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm ${u.currency?"border-red-300":"border-gray-300"}`,...o("currency",{required:"Currency is required"}),children:[e.jsx("option",{value:"INR",children:"â‚¹ INR"}),e.jsx("option",{value:"USD",children:"$ USD"})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"engagement_type",className:"block text-sm font-medium text-gray-700 mb-1",children:"Engagement Type"}),e.jsxs("select",{id:"engagement_type",className:"block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm border-gray-300",...o("engagement_type"),children:[e.jsx("option",{value:"",children:"Select engagement type"}),e.jsx("option",{value:"retainership",children:"Retainership"}),e.jsx("option",{value:"project",children:"Project Based"}),e.jsx("option",{value:"milestone",children:"Milestone Based"}),e.jsx("option",{value:"service",children:"Service Based"})]}),l&&e.jsxs("p",{className:"mt-1 text-xs text-gray-500",children:["Client's default: ",l.type.charAt(0).toUpperCase()+l.type.slice(1)]})]})]})]}),de(),e.jsx(fe,{register:o,control:h,updateTaxSettings:ne}),e.jsx(be,{subtotal:Q,tax:z,total:H,selectedCurrency:_,taxPercentage:y}),e.jsx(ge,{register:o})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row sm:justify-end space-y-3 sm:space-y-0 sm:space-x-3 mb-8",children:[e.jsx("button",{type:"button",onClick:()=>I("/recurring"),className:"btn btn-secondary btn-md",children:"Cancel"}),e.jsxs("button",{type:"submit",disabled:A,className:"btn btn-primary btn-md group",children:[e.jsx(we,{className:"h-4 w-4 mr-2 group-hover:scale-110 transition-transform"}),A?e.jsxs("span",{className:"flex items-center",children:[e.jsx("span",{className:"h-4 w-4 mr-2 rounded-full border-2 border-white/30 border-t-white animate-spin"}),"Saving..."]}):"Save Recurring Invoice"]})]})]})]})};export{$e as default};
