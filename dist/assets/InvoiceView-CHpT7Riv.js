import{d as k,a as N,b as S,r as c,j as r,V as g}from"./index-DMTdQ3St.js";import{u as C}from"./invoiceStore-ACMv2w23.js";import{u as D}from"./clientStore-Bedc05g4.js";import{n as E}from"./invoiceDataTransform-CE6YmDep.js";import{I as M}from"./InvoicePreviewContent--PJ4DIc5.js";import R from"./RecordPaymentModal-Czj0x9qc.js";import"./helpers-kgrKKtTT.js";import"./jspdf.es.min-CZuQBE25.js";import"./Modal-D67shZbf.js";import"./x-CNnEMBry.js";import"./invoice-BGlX5FmL.js";import"./calendar-CRwE0Pfy.js";const K=()=>{const{id:n}=k(),u=N(),{selectedInvoice:e,invoiceItems:d,fetchInvoice:l,fetchInvoiceItems:p,recordPayment:h,loading:v}=C(),{profile:t,bankingInfo:s,fetchProfile:_,fetchBankingInfo:f}=S(),{getClient:y}=D(),[m,x]=c.useState(null),[w,b]=c.useState(!1),[o,I]=c.useState(null);c.useEffect(()=>{n&&(l(n),p(n))},[n,l,p]),c.useEffect(()=>{(async()=>{if(e){await _(e.user_id),await f(e.user_id);try{const a=await y(e.client_id);I(a)}catch(a){console.error("Error loading client details:",a)}}})()},[e,_,f,y]),c.useEffect(()=>{if(e&&t&&o){const i={issuer:{business_name:t.business_name||"Your Business",address:t.address||"",pan_number:t.pan_number,phone:t.phone,logo_url:t.logo_url||void 0,primary_color:t.primary_color,secondary_color:t.secondary_color,footer_text:t.footer_text},client:{name:o.name||"",company_name:o.company_name,billing_address:o.billing_address,email:o.email,phone:o.phone,gst_number:o.gst_number},banking:s?{account_holder:s.account_holder,account_number:s.account_number,ifsc_code:s.ifsc_code,bank_name:s.bank_name,branch:s.branch}:void 0,invoice:{invoice_number:e.invoice_number,issue_date:e.issue_date,due_date:e.due_date,subtotal:e.subtotal,tax:e.tax,total:e.total,notes:e.notes,currency:e.currency||"INR",tax_percentage:e.tax_percentage||0,engagement_type:e.engagement_type,payment_date:e.payment_date,payment_method:e.payment_method,payment_reference:e.payment_reference,is_partially_paid:e.is_partially_paid,partially_paid_amount:e.partially_paid_amount,status:e.status}};e.engagement_type==="milestone"?i.invoice.milestones=d.map(a=>({name:a.description||a.milestone_name||"Milestone",amount:a.amount})):i.invoice.items=d,x(E(i))}},[e,t,o,s,d]);const P=async i=>{if(n)try{await h(n,i),g.success("Payment recorded successfully"),b(!1),l(n)}catch(a){console.error("Error recording payment:",a),g.error("Failed to record payment")}};if(v||!e||!m)return r.jsx("div",{className:"flex justify-center items-center h-screen",children:r.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"})});const j=["draft","sent","overdue","partially_paid"].includes(e.status);return r.jsxs("div",{className:"fixed inset-0 bg-gray-100 overflow-auto",children:[r.jsxs("div",{className:"fixed top-4 right-4 z-10 space-x-2 print:hidden",children:[j&&r.jsx("button",{onClick:()=>u(`/invoices/${n}`),className:"bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md shadow-md text-sm font-medium",children:"Manage Invoice"}),r.jsx("button",{onClick:()=>u("/invoices"),className:"bg-gray-100 text-gray-700 hover:bg-gray-200 px-4 py-2 rounded-md shadow-md text-sm font-medium border border-gray-300",children:"Back to Invoices"})]}),m&&r.jsx(M,{data:m,allowDownload:!0}),r.jsx(R,{isOpen:w,onClose:()=>b(!1),onSave:P,invoice:e})]})};export{K as default};
